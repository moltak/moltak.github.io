---
title: "내가 TDD 하는 방식"
description: "결제 API 예시로 보는 나의 TDD 실전 방법론 - Controller, Service 테스트"
date: "Apr 04 2021"
draft: true
---

# 들어가며

나와 함께 프로젝트 진행을 했던 사람들이라면 알겠지만 나는 TDD없이는 코딩을 잘 하지 않는다. 내가 TDD를 하는 이유는 여러가지가 있지만 요새는 Test코드가 없을 때 오는 두려움이 가장 큰 이유인것 같다.

이 글이 언제 완성될지 모르겠지만 내가 TDD를 어떻게 하는지에 대해 글을 써본다.

예를들어보자. Feature A를 만들고 배포해야한다고 하자. TDD를 하지 않거나 Test를 짜지 않는 개발자들은 이렇게 한다. Feature A를 만든다. 누른다. 혹은 어떤 방식으로 로직을 실행한다. 여러 시나리오를 해본다. 수정한다. 누른다. 혹은 어떤 방식으로 로직을 실행한다. 수정한다.. 이하 반복

여기서 가장 시간을 많이 잡아먹는 일이 뭔지 아나? 구현하는거? 아니다 누르고, 어떤 방식으로 실행해보는거다.

TDD를 하면 이렇게 바뀐다. 시나리오를 생각한다. 테스트를 짠다. 로직을 짠다. 테스트를 실행한다. 실패한다. 로직을 짠다.

TDD는 이게 전부다. 그리고 너가 짠 로직을 테스트하는데 고민을 많이 하게 하지 않는다. 물론 이건 숙달됐을 때고 처음에는 뭘해야할지 몰라 엄청나게 헤멘다 ㅋ

TDD를 안하고 Test코드를 안짤때의 문제는 여기서 끝나지 않는다. 1년쯤 지난 후 Feature B를 개발한다고 생각해보자. 근데 Feature B는 Feature A와 연관이 많다. 이런경우 Feature B를 개발함으로써 A에 지장을 준다. B를 개발하고 Test코드가 없다면 A에 이상이 없다는걸 어떻게 검증할까? 하나하나 눌러보겠지? 테스트 시나리오는 다 통과해야하고 그게 실행이 어렵다면 예를들어 카드를 10개씩 등록해야하는 테스트라면? 난 이런 테스트가 정말 싫다.

TDD는 이런것들로부터 해방을 시킨다. B가 개발됐는데 A에 지장을 주지 않는다는걸 어떻게 보장할까? 그냥 테스트를 실행해보면 된다. 그걸로 끝이다.

# 내가 TDD하는 방법

상세한 내용을 적기엔 좀 준비해야할게 많으니 간략히 써보겠다. 예를들어 결제 RESTful API를 구현한다고 생각해보자. 뭐가 필요할까?

1. Controller (router)
2. Service (비즈니스 로직)
3. 3rd party (결제 서비스 integration)
4. Repository (결제 내역 디비에 저장등)

나는 저 네가지 모두를 각각 격리해서 테스트를 짜는데 어떻게 하는지 설명을 해보겠다.

# 첫단계 (Controller Test)

나는 보통 Controller 부터 TDD를 하는 편인데, 이렇게 해야 여러번 수정해야할 일이 적기 때문이다. 보통 Controller를 개발하기 전에 Interface를 설계 (URI, Body, Request Param, Path Param 같은..) 하게 되는데 이때 다른 개발자들과 대화가 많이 필요하다. 기획서에도 잘 맞춰야하고. 그래서 처음 TDD를 하는 사람은 도대체 뭘 해야할지 감이 안오기 때문에 Controller 부터 테스트를 짜는게 낫다.

이런 시나리오를 떠올려보자. 사용자가 카드 결제하면 어떤 결과를 반환할까? 결제가 성공하고 실패할텐데, 성공은 언제 실패는 언제할까? 이걸 떠올리고 테스트를 짜기 시작하는게 TDD다. 나는 당장 몇개가 떠오르는데.

실패:
1. 카드에 잔고가 부족
2. 카드 정보가 틀림
3. 카드 유효기간이 지남
4. 분실카드임

실패는 위와 같이 여러개가 존재한다. 이 각각에 대해 테스트를 짠다. 예를들이 1번 실패면 어떤 메세지와 어떤 Status 코드가 반환되야 하는지. 뭐 그런식이다.

반면 성공케이스는 하나정도 떠오른다. 결제되었습니다. 가 반환되면 되고 아마 200, 201? status code 가 반환되면 될것 같다.

# 두번째 (Service Test)

서비스는 작성하기가 가장 좀 까다로울 수 있다. 왜냐면 Dependency가 많기 때문이다. 보통 Service 클래스는 Controller → Service → 3rd party → Repository 처럼 여러 클래스들과 인터렉션이 필요해서 조금 테스트가 복잡하다. 이때 도움을 주는건 [책임 기반 설계, 행동 기반 설계](https://loopstudy.tistory.com/131)인데, 데이터를 떼어내고 생각할 수 있어야한다.

예를들어 이런 시나리오를 떠올려보자.

1. 결제 모듈에서 잔고가 없다고 한다 → exception catch 후 어떤 동작을 해야할까?
2. 결제 모듈에서 카드 정보가 틀리다고 한다 → exception catch 후 어떤 동작을 해야할까?
3. 결제 모듈에서 카드 유효기간이 지났다고 한다 → exception catch 후 어떤 동작을 해야할까?
4. 결제 모듈에서 분실카드라 한다 → exception catch 후 어떤 동작을 해야할까?

위와같은 시나리오를 생각해보고 각 시나리오마다 어떤 값을 반환해야하는지 고민하며 테스트를 작성한다.
